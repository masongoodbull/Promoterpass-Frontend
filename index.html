<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Redeem Your Pitcher</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 50px; }
    input, button {
      font-size: 18px;
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #redeemBtn {
      font-size: 20px;
      padding: 10px 30px;
    }
    #response { margin-top: 10px; color: green; }
  </style>
</head>
<body>

  <h1>üçª Free Pitcher Redemption</h1>

  <!-- Phone opt-in form -->
  <div>
    <h3>Send Invite to Phone</h3>
    <input id="phoneInput" type="text" placeholder="Enter phone number" />
    <button onclick="sendInvite()">Send Invite</button>
    <div id="response"></div>
  </div>

  <hr />

  <!-- Redemption Status Section -->
  <div id="status">Loading...</div>
  <button id="redeemBtn" style="display:none;">Redeem Free Pitcher</button>

  <!-- ‚¨áÔ∏è MOVE SCRIPT HERE ‚¨áÔ∏è -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      updateDoc
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCRPqNmhMbyS4IFkkO6ZfUJVHCb7h4E64Y",
      authDomain: "promoterpass-ea092.firebaseapp.com",
      projectId: "promoterpass-ea092",
      storageBucket: "promoterpass-ea092.firebasestorage.app",
      messagingSenderId: "324225838474",
      appId: "1:324225838474:web:e86971349a98c5ce51ac73",
      measurementId: "G-XLKY1XCXD4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const statusDiv = document.getElementById('status');
    const redeemBtn = document.getElementById('redeemBtn');

    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    if (!code) {
      statusDiv.innerHTML = "Invalid redemption link.<br><small>To test: add <code>?code=test123</code> to the URL</small>";
    } else {
      const redemptionsRef = collection(db, "redemptions");
      const q = query(redemptionsRef, where("code", "==", code));

      getDocs(q).then(snapshot => {
        if (snapshot.empty) {
          statusDiv.textContent = "This code does not exist.";
          return;
        }

        const redemptionDoc = snapshot.docs[0];
        const data = redemptionDoc.data();

        if (data.redeemed) {
          statusDiv.textContent = "‚úÖ Already Redeemed";
        } else {
          statusDiv.textContent = "You have a free pitcher waiting!";
          redeemBtn.style.display = "inline-block";

          redeemBtn.addEventListener("click", async () => {
            const confirmRedeem = confirm("Are you sure you want to redeem?");
            if (!confirmRedeem) return;

            try {
              await updateDoc(doc(db, "redemptions", redemptionDoc.id), { redeemed: true });
              statusDiv.textContent = "‚úÖ Successfully Redeemed!";
              redeemBtn.disabled = true;
              redeemBtn.textContent = "Redeemed ‚úÖ";
            } catch (error) {
              console.error("Error updating document:", error);
              statusDiv.textContent = "Error processing redemption.";
            }
          });
        }
      }).catch(error => {
        console.error("Error accessing Firestore:", error);
        statusDiv.textContent = "Error loading redemption data.";
      });
    }

    // Opt-in handler
    window.sendInvite = async function () {
      const phoneInput = document.getElementById('phoneInput').value;
      const responseDiv = document.getElementById('response');
      if (!phoneInput) return (responseDiv.textContent = "‚ö†Ô∏è Please enter a number.");

      try {
        const res = await fetch('https://promoterpass-backend.onrender.com', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: phoneInput })
        });

        const data = await res.json();
        responseDiv.textContent = data.success
          ? 'üì≤ Invite sent successfully!'
          : '‚ùå Failed to send invite.';
      } catch (err) {
        console.error(err);
        responseDiv.textContent = "‚ùå Error sending invite.";
      }
    };
  </script>
</body>
</html>
